<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I LOVE YOU</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; cursor: pointer; font-family: sans-serif; }
        canvas { display: block; }
        
        #ui-layer {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20; pointer-events: none;
            text-align: center; width: 100%;
        }

        #heart-text {
            color: #00f2ff; font-size: clamp(2rem, 10vw, 4rem);
            font-weight: 900; text-shadow: 0 0 15px #00f2ff, 0 0 30px #00f2ff;
            letter-spacing: 5px; opacity: 0; transition: 1.5s;
        }

        #ui-layer.pulse { animation: heartbeat 1s infinite; opacity: 1; }
        #heart-text.show { opacity: 1; }

        #click-hint {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            color: #ff3385; font-size: 14px; font-weight: bold;
            opacity: 0; transition: 1s; letter-spacing: 2px;
        }
        #click-hint.show { opacity: 0.8; animation: blink 1.5s infinite; }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; justify-content: center;
            align-items: center; color: #fff; opacity: 0; visibility: hidden;
            transition: 1s; z-index: 100;
        }
        #overlay.active { opacity: 1; visibility: visible; }
        .typewriter { font-size: 1.2rem; line-height: 1.8; border-left: 4px solid #ff3385; padding: 20px; max-width: 80%; }

        @keyframes heartbeat {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.15); }
        }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
    </style>
</head>
<body>

<audio id="bgMusic" loop><source src="nhac.mp3" type="audio/mpeg"></audio>

<div id="ui-layer">
    <div id="heart-text">...I LOVE YOU...</div>
</div>
<div id="click-hint">CLICK VÀO ĐỂ TIẾP TỤC</div>

<canvas id="canvas"></canvas>

<div id="overlay">
    <div class="typewriter"><span id="text"></span></div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const music = document.getElementById('bgMusic');

let rockets = [], particles = [], heartPoints = [], phase = 'firing', timer = 0;

function initHeart() {
    heartPoints = [];
    const r = Math.min(window.innerWidth, window.innerHeight) * 0.045; 
    // Tạo 1 lớp viền trái tim duy nhất
    for (let t = 0; t < Math.PI * 2; t += 0.05) {
        const x = 16 * Math.pow(Math.sin(t), 3);
        const y = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
        heartPoints.push({ x: x * r, y: y * r });
    }
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    initHeart();
}
window.addEventListener('resize', resize);

class Rocket {
    constructor() {
        this.x = Math.random() * canvas.width;
        this.y = canvas.height;
        this.targetY = Math.random() * (canvas.height * 0.5);
        this.speed = Math.random() * 2 + 5;
        this.color = `hsl(${Math.random() * 360}, 100%, 60%)`;
        this.exploded = false;
    }
    update() {
        this.y -= this.speed;
        if (this.y <= this.targetY) { this.exploded = true; explode(this.x, this.y, this.color); }
    }
    draw() {
        ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill();
    }
}

class Particle {
    constructor(x, y, color, target) {
        this.x = x; this.y = y;
        this.color = color;
        this.target = target;
        this.vx = (Math.random() - 0.5) * 15;
        this.vy = (Math.random() - 0.5) * 15;
        this.friction = 0.95;
        this.isHeartParticle = false;
    }
    update() {
        if (phase === 'firing') {
            this.x += this.vx; this.y += this.vy;
            this.vx *= this.friction; this.vy *= this.friction;
            this.vy += 0.05;
        } else {
            // Khi tụ lại, chuyển sang màu hồng rực
            this.color = '#ff3385';
            
            // Tính toán nhịp đập cho các chấm pháo hoa
            const scale = 1 + Math.sin(Date.now() / 160) * 0.075;
            const tx = canvas.width/2 + this.target.x * scale;
            const ty = canvas.height/2 + this.target.y * scale;

            this.x += (tx - this.x) * 0.05;
            this.y += (ty - this.y) * 0.05;
        }
    }
    draw() {
        ctx.fillStyle = this.color;
        if (phase === 'converging') {
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#ff3385';
        }
        ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    }
}

function explode(x, y, color) {
    for (let i = 0; i < 60; i++) {
        const target = heartPoints[Math.floor(Math.random() * heartPoints.length)];
        particles.push(new Particle(x, y, color, target));
    }
}

function animate() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    timer++;

    if (phase === 'firing') {
        if (timer % 12 === 0 && timer < 600) rockets.push(new Rocket());
        if (timer === 680) {
            phase = 'converging';
            document.getElementById('ui-layer').classList.add('pulse');
            document.getElementById('heart-text').classList.add('show');
            document.getElementById('click-hint').classList.add('show');
        }
    }

    rockets = rockets.filter(r => !r.exploded);
    rockets.forEach(r => { r.update(); r.draw(); });
    particles.forEach(p => { p.update(); p.draw(); });
    requestAnimationFrame(animate);
}

window.addEventListener('click', () => {
    if (phase === 'converging') {
        music.play().catch(() => {});
        const overlay = document.getElementById('overlay');
        if(!overlay.classList.contains('active')) {
            overlay.classList.add('active');
            const msg = "Chúc mừng năm mới 2026! Pháo hoa đêm nay rực rỡ thật, nhưng lòng tớ lại trĩu nặng vì biết ngày cậu chuyển đi đã cận kề.\n\nTớ hối hận vì đã giấu kín tình cảm này quá lâu... Cậu là thanh xuân rực rỡ nhất mà tớ từng biết. Chúc cậu hạnh phúc ở nơi mới nhé. Tạm biệt cậu...";
            let i = 0;
            function type() {
                if (i < msg.length) {
                    document.getElementById("text").innerHTML += msg.charAt(i);
                    i++; setTimeout(type, 60);
                }
            }
            setTimeout(type, 500);
        }
    }
});

resize();
animate();
</script>
</body>
</html>